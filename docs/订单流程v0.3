订单流程
version:0.3
[TOC]

## 1. 金额有关字段和计算方法
### 1.1 金额有关字段
* Order：
>* sharedPostFee(分摊邮费之和)
>* sharedDiscountFee(分摊优惠金额之和)
>* actualFee（成交金额）
>* goodsFee（货款）

* OrderItem:
>* **price(一口价)**
>* discountPrice(促销价) = (price * num - discountFee) / num
>* **num(订购数量)**
>* **discountFee(订单项优惠金额)**
>* sharedDiscountFee（分摊优惠金额） = 整单优惠金额 * (促销价 * num/订单下面所有订单项(促销价*数量)之和)
>* sharedPostFee（分摊邮费）
>* actualFee（成交金额）
>* postCoverFee(邮费补差金额)
>* postCoverRefundFee(邮费补差退款金额)
>* serviceCoverFee（服务补差金额）
>* serviceCoverRefundFee（服务补差退款金额）
>* refundFee(线上退款金额)
>* offlineRefundFee(线下退款金额)
>* returnPostFee(线上退货邮费)
>* offlineReturnPostFee(线下退货邮费)
>* exchangePostFee(售后换货邮费)
>* incomeFee(实际收入金额)*
>* goodsFee(货款)

### 1.2 金额计算方法
* Order: 
> order下面所有订单项的金额之和就是order的金额

* OrderItem(类型为正常/赠品/套餐/补货/售后换货):
>* **actual_fee(订单项成交金额,平台结算金额)** = total_fee(total_fee = 天猫total_fee = ((price*num) - discount_fee(订单项优惠金额=单个优惠金额*num))) + shared_post_fee(分摊的邮费) - refund_fee(线上账面退货金额) 
>* **goodsFee(货款,商家结算金额)** = (price*num) - discount_fee(订单项优惠金额=单个优惠金额*num) - actualRefundFee(线上实际退货金额) + serviceCoverFee(服务补差金额) - serviceCoverRefundFee（服务补差退款金额） - offlineRefundFee(线下退款金额)
>* **实际的成交金额(未实现该字段)** = 平台结算金额 - shared_discount_fee(分摊的整单优惠金额)

* OrderItem(类型为售前换货):
>* **actual_fee(订单项成交金额)** = 被换货订单项actual_fee
>* **goodsFee(货款)** = 被换货订单项goodsFee + serviceCoverFee(服务补差金额) - serviceCoverRefundFee（服务补差退款金额） - offlineRefundFee(线下退款金额)

## 2. 订单流程
### 2.1 订单状态变化
>* 待审核(可选)(手动下单待审核)->待处理->已确认->已打印->已验货->已发货->已签收
>* 待审核(or 待处理 or 已确认 or 已打印 or 已验货)->已作废
>* 已确认(or 已打印 or 已验货 )->待处理
>* 已作废->待审核
(暂不考虑京东的锁定和取消订单)

### 2.2 订单退货状态
>* 正常/部分退货/已退货

### 2.3 订单其他和状态有关的字段
>* 订单有效状态:有效,无效
>* 订单被拆分或合并的时候,会生成新订单对象,那么原来的订单对象会被标记为无效
>* 订单类型:普通/补货/换货
>* 订单生成类型:手动创建/手动拆分/手动合并/自动创建/自动拆分/自动合并
>* ~~是否正在申请退款:true/false~~

### 2.4 订单项状态
>* 未签收/已签收
从外部平台API获取原始订单的状态变化,如果状态变化为确认收货(TRADE_FINISHED或TRADE_BUYER_SIGNED),
根据外部平台子订单号找到对应的真实订单项,标记为已签收,并且更新该订单项对应的真实订单的状态.根据订单项状态同时修改订单状态.

### 2.5 订单项线上退货状态
>* 正常/已退货

### 2.6 订单项线下退货状态
>* 正常/已退货

### 2.7 订单项其他和状态有关的字段
>* 订单项类型:正常/套餐/赠品/售前换货/补货/售后换货
>* 当在系统内进行售前换货操作,新添加的订单项类型设为售前换货
>* 当在系统内进行新建换货订单操作,新添加的订单项类型设为售后换货
>* 当在系统内进行加产品或者新建补货订单操作,新添加的订单项类型为赠品或者补货
>* 是否被售前换货:true/false
>* 当在系统内进行售前换货操作,被选择的订单项该字段设为true
>* ~~是否正在申请退款:true/false~~

## 3. 订单操作
### 3.1 手动下单
首先需要选择平台,如果是天猫或京东的单,只能选择补货或换货的订单,否则还可以选择普通订单.
补货订单在加订单项的时候只能选择赠品和补货,普通订单还可以选择正常商品和套餐商品.
赠品和补货不能修改价格信息,只能输入订货数量,换货邮费,并且可以选择换货邮费承担方(买家,卖家,供应商).
其中正常商品和套餐商品可以修改单价,订货数量,订单项优惠,整单优惠分摊,分摊邮费.
换货订单(只支持1换多)
新建换货订单,输入智库城订单号,系统会列出下面所有订单项,可以选中订单项(被售前换货为true的订单项不能选择),然后输入查询条件搜索一个产品,点击产品后面的添加按钮.
点击之后将原订单的订单项的复选框变成不可编辑,并且清空产品搜索栏中的信息.
此时会将该换货产品添加到换货订单的订单项中,可以修改产品数量,换货邮费,邮费承担方.
订单项可以删除,删除之后订单项的复选框被取消并且又可以进行点击.
//保存的时候需要校验所添加的换货产品都属于同一个仓库.
如果需要为换货订单添加赠品或补货,则在创建完换货订单之后使用加产品功能进行添加.

### 3.2 复制订单
点击的时候只需要复制收货人的信息,其余的逻辑与手动下单一样

### 3.3 手动拆分
订单状态为待处理的订单才能进行手动拆分
退货状态不为正常的订单能进行手动拆分
验过货的订单不能进行手动拆分
被分配过货款的订单不能进行手动拆分
类型为正常的订单才能进行手动拆分
正在申请退款的订单不能进行手动拆分
拆分合并订单对数据库订单相关表的影响:
拆分出来的订单生成新的订单对象和订单项对象(拷贝原来的订单信息),并且生成一条订单拆分合并记录,将原订单的is_valid设为false
因为发货之后就不能再对订单进行改状态以及拆合,所以不需要复制发货信息和出库信息


### 3.4 加产品
只能对待处理的订单进行该操作
加产品的时候只能加赠品和补货.加入金额为0,不能修改任何金额.
加入的产品需要和订单属于同一仓库

### 3.5 删除订单项
只能对待处理的订单进行该操作,否则提示"只有待处理的订单才能进行删除订单项的操作".
订单项退货状态需要为正常,否则提示"订单项不能删除,已发生退货"
订单项被换货字段需要为false,否则提示"订单项不能删除,已被换货"
订单项不能有退款申请的记录,否则提示"订单项不能删除,请先删除该订单项的退款记录".
订单项不能有预收款分配记录,否则提示"订单项不能删除,请先删除外部订单号为[此处为预收款的外部平台订单号]的分配记录".
删除订单项只能删除赠品,补货,售前换货.
删除赠品或补货,直接将订单项删除.
删除售前换货,将原始被换货的订单项的被换货设为false,然后把订单项删除.
删除售后换货,直接提示"售后换货订单项不能删除,请直接作废订单".


### 3.6 抓取线上退款(定时器完成)
系统会从天猫抓取退款信息(退货),退款信息会关联到外部平台子订单号.
首先得判断是订单退款还是预收款退款(先根据交易号去订单表查,没有查到再去预收款表查).
如果是预收款退款,创建一条退款记录,退款类型为预收款退款.并修改预收款的退款金额,修改预收款的分配状态为待分配.
如果是订单退款,创建一条退款记录,退款类型为订单退款.
退款单有3个状态:正在申请退款/退款成功/退款失败.从外部平台抓取的退款记录会映射到这三种状态.
退款单有阶段,表明是售前退款还是售后退款.  

对于订单退款:
如果是正在申请退款,需要同时修改订单项和订单的正在申请退款为true.
当状态从正在申请退款自动变更到退款完成的状态时,需要同时更新订单项的退款金额,并且修改正在申请退款为false.
可以对状态为退款成功的退款记录进行修改,标记同时退货,并且输入实际退款金额和运费.需要满足实际退款金额<=退款金额.  

对于预收款退款:
如果状态为成功,需要更新预收款的退款金额.
修改预收款分配状态为待分配.


### 3.7 新建线下退款(退货)申请(只能对天猫和京东的订单进行该操作)
如果要新建退款同时退货记录,订单项的线下退货状态需要为正常.
被选择的订单项的是否被售前换货字段为false
只能新建订单退款申请.
新建退款申请,可以输入外部订单号或智库城订单号来查询订单项,可以选中某个订单项,然后可以输入退款金额.退款原因,备注,回访时间.
此时有一个复选框:同时退货.如果选中,还可以输入线下退货邮费,线下退货邮费承担方.实际退款金额(线下退款的话,该金额一般等于退款金额).
可以选择退款状态(正在申请/成功),默认为正在申请.
如果状态为成功,保存的时候会更新订单项的线下退货状态,线下退款金额,线下退货邮费.
线下退款申请可以被删除,删除之后要做对应的恢复操作.
注意对套餐产品进行线下退货,退的是单品.  

如果这笔退款同时发生了退货,这时候因为发生了退货邮费,所以客服需要设置该笔退款金额中有多少是邮费.
客服找到该笔退款记录,手动进行修改,选中同时进行了退货,此时可以输入退货邮费以及退货邮费承担方.保存之后会更新订单项的退货状态,退款金额,退货邮费.
此时系统根据退款记录来判断是修改线上还是线下,同时如果线上或线下是已经退货的状态,则不允许该操作发生.


### 3.8 修改退款申请
线上退款不能修改账面退款金额,退款时间,退款状态.
线下退款的字段都能进行修改.如果线下退款状态已经为退款成功,则不能再修改退款状态.


### 3.9 售前换货(只能对天猫的订单进行该操作,只支持1换1)
1) 换相同价位的货物或者换更贵的
使用换货功能:
只能对待处理的订单进行该操作
只有类型为正常商品,被售前换货为false的订单项才能进行售前换货
选中订单,点击换货,弹出框上半部分列出订单当前的订单项,只能选中一个,弹出框下面可以选择一个新的产品(需要是同一个仓库).保存的时候将选中的订单项被售前换货设为true,新生成的订单项类型为售前换货,并且设置exchangeSourceId为被换货的订单项ID.
新生成的订单项,单价,折扣价,订单项优惠,分摊整单优惠,分摊邮费均为0.
如果买家拍了一笔服务补差,可以到预收款分配页面将服务补差分配到该新订单项.  

2)换成更加便宜的商品或者减少购买数量
先看换成更加便宜的商品如何处理.
分两种处理情况:
* 退款走线上,顾客在天猫后台去退部分款
系统会自动抓取天猫的退款记录,记录退款金额.
* 退款走线下,客服将钱直接从支付宝打给顾客
客服可以新建一笔退款申请,录入退货金额和退货时间.  

然后参照上面的步骤使用售前换货功能.
减少购买数量也相当于进行售前换货.

### 3.10 预收款分配(只能对天猫和京东的订单进行该操作)
邮费补差订单和服务补差订单在抓取之后会产生预收款.
预收款包括预收金额, 类型(邮费补差,服务补差,订单邮费), 分配状态(待分配,已分配,售前退款), 来源(哪个平台,外部订单号多少), 退款金额等.
以邮费为例,邮费存在3种情况:
1) 从天猫抓来的订单中包含邮费金额;
2) 订单中包含邮费补差(虚拟邮费产品)并有其他产品;
3) 单独的邮费补差订单,即订单中只有邮费补差产品没有其他产品
第一种情况,系统会创建一条预收款记录,预收金额为订单里的邮费金额,分配状态为未分配,类型为订单邮费预收款.
第二和第三种情况,系统会查看订单下面的订单项是否是邮费补差产品,如果是的话,创建一条预收款记录,预收金额为补差产品购买数量,同时移除该订单项.分配状态为未分配,类型为订单邮费预收款邮费补差预收款.
如果移除完该订单项之后订单没有其他的订单项,则系统不会创建该订单.
服务补差抓取处理逻辑与邮费补差类似,只是创建的预收款类型为服务补差预收款.  

* 邮费补差和服务补差预收款分配
被分配的订单项有限制条件:被售前换货为false, 并且预收款的来源平台需要和被分配的订单项平台和店铺相同.
分配保存的时候需要校验,所分配的金额之和=预收款金额,所分配的退款金额之和=预收款退款金额.修改分配状态为已分配.
可以对分配记录做删除,系统需要做对应的恢复操作.
* 订单邮费预收款分配
被分配的订单项有限制条件:订单项类型必须是正常商品或套餐, 并且预收款的来源平台需要和被分配的订单项平台和店铺相同, 并且被分配的订单项的外部平台交易号与预收款的外部订单号相同.
分配保存的时候需要校验,所分配的金额之和=预收款金额.修改分配状态为已分配.
订单邮费分配之后要更新订单项的分摊邮费金额.
可以对分配记录做删除,系统需要做对应的恢复操作.


## 4. 备注
1. 进行订单批量验货的时候,往天猫发送发货请求.
2. 在确认订单的时候,满足校验条件:
1) 根据该订单的外部平台订单号,找到对应的订单邮费预收款,需要判断该订单邮费预收款已经被全部分配,否则不允许确认.
2) 需要判断订单没有正在申请退款,并且退货状态不为已退货.
3. 有2个路径可以将订单从已验货变为已发货:1)通过定时任务向天猫查询已验货订单的物流信息,如果已经是物流公司揽收成功的状态,将订单状态改为已发货.2)手动确认已发货
4. 有2个路径可以将订单从已发货变为交易完成:1)通过定时任务向天猫查询已发货订单的收货信息,如果已经是卖家已签收或交易完成,将订单状态改为部分签收或交易完成.2)针对每个订单项手动确认签收
5. 订单在导入进销存(确认订单)的时候扣减总库存以及平台库存,在取消确认操作的时候增加对应的总库存以及平台库存
6. 和套餐有关的问题
1) 在新建套餐的时候所为套餐项设置的单价,需要是优惠后的实际价格.例如天猫中一个套餐的实际价格为300元,那么在系统中设置的套餐项需要满足(Sum(套餐项价格*数量)=300),不考虑整单优惠.
2) 系统在抓单的时候发现产品是套餐,会将实际的套餐产品作为订单项加入订单中,此时套餐产品订单项的单价为系统中设置的套餐项单价,数量为(系统中设置的套餐项单价*产品数量),整单优惠金额自动按照套餐价格占比自动分摊.
3) 系统自动抓取退货记录,如果发现是退套餐的话,会将退货金额按照套餐价格占比自动分摊到对应的订单项中,并且将他们的退货状态改为线上退货.线下退货则是退单品.
4) 暂不支持套餐换货
7. 关于邮费结算问题,在三种情况下会产生邮费.
1) 正常发货,买家下单的时候会支付邮费(也可能没有,比如包邮),这种邮费由平台商代收,与供应商结算的时候把邮费支付过去.
2) 产生退货,买家把货物寄回来,此时存在3种情况:买家承担,平台商承担和供应商承担.如果是买家承担,退款中的邮费为0,只退货款.
如果是平台商或供应商承担,退款中还应包括单独的邮费支付给买家.在和外部平台对账的时候,该邮费还是要考虑进去的.
只是和供应商结算的时候,不论是谁承担邮费,算货款的时候该邮费都应该排除.只是单独的邮费报表中需要体现.
3) 产生换货,首先买家可能会寄回货物(也可能不会),参考上面的退货邮费.产生换货订单的时候,也需要输一个换货邮费,此时也存在2种情况:平台商承担和供应商承担.
处理情况也和上面类似,算货款的时候该邮费都应该排除.只是单独的邮费报表中需要体现.
8. 邮费报表所列项:
分摊邮费,邮费补差,邮费补差退款,线上退货邮费,线上退货邮费承担方,线下退货邮费,线下退货邮费承担方,换货邮费,换货邮费承担方,结算邮费
结算邮费=分摊邮费 + 邮费补差 - 本期发生的邮费补差退款 + 本期发生的线上退货邮费(如果是供应商承担) + 本期发生的线下退货邮费(如果是供应商承担) + 本期发生的换货邮费(如果是平台商承担)
9. 外部平台订单状态变化:
天猫(子订单):
1) TRADE_NO_CREATE_PAY(没有创建支付宝交易)
2) WAIT_BUYER_PAY(等待买家付款)
3) WAIT_SELLER_SEND_GOODS(等待卖家发货,即:买家已付款)[intersted]
4) WAIT_BUYER_CONFIRM_GOODS(等待买家确认收货,即:卖家已发货)[intersted]
5) TRADE_BUYER_SIGNED(买家已签收,货到付款专用)
6) TRADE_FINISHED(交易成功)[intersted]
7) TRADE_CLOSED(付款以后用户退款成功，交易自动关闭)
8) TRADE_CLOSED_BY_TAOBAO(付款以前，卖家或买家主动关闭交易)
京东:
1） WAIT_SELLER_STOCK_OUT 等待出库[intersted]
2） SEND_TO_DISTRIBUTION_CENER 发往配送中心（只适用于LBP，SOPL商家）
3） DISTRIBUTION_CENTER_RECEIVED 配送中心已收货（只适用于LBP，SOPL商家）
4） WAIT_GOODS_RECEIVE_CONFIRM 等待确认收货[intersted]
5） RECEIPTS_CONFIRM 收款确认（服务完成）（只适用于LBP，SOPL商家）
6） WAIT_SELLER_DELIVERY等待发货（只适用于海外购商家，等待境内发货 标签下的订单）
7） FINISHED_L 完成[intersted]
8） TRADE_CANCELED 取消
9） LOCKED  已锁定
10. 售前换货订单项.
在发货页面,不列出被换货为true的订单项.
对账页面,换货与被换货都会列出.

## 5. TODO
1. 与供应商结算之前需要运营预先设置好品牌和商品参与优惠的规则
2. 与供应商结算之前需要运营预先设置好品牌和商品的结算规则
3. 邮费明细单独报表